<h2 mat-dialog-title class="text-2xl text-center">Nota de Crédito — Ticket #{{ data.sale.saleId }}</h2>

<form [formGroup]="form">
  <mat-dialog-content class="flex flex-col gap-4">
    <div class="text-sm text-gray-600">
      Cliente: <b>{{ data.sale.businessName || "-" }}</b>
    </div>

    <div class="border rounded p-3 overflow-auto">
      <div formArrayName="items">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2">Producto</th>
              <th class="py-2 text-right">Precio</th>
              <th class="py-2 text-center">Cantidad</th>
              <th class="py-2 text-center">Devolver</th>
              <th class="py-2 text-right">Subtotal</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let g of items.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i"
              class="border-b">
              <td class="py-2">{{ g.get('productName')?.value }}</td>
              <td class="py-2 text-right">{{ g.get('unitPrice')?.value | currency:'MXN' }}</td>
              <td class="py-2 text-center">{{ g.get('maxQty')?.value }}</td>

              <!-- Input numérico -->
              <td class="py-2 text-center">
                <mat-form-field appearance="fill" class="w-28">
                  <input matInput type="number" formControlName="qty" min="0" [max]="g.get('maxQty')?.value" step="1"
                    (input)="onQtyInput(i)" (blur)="onQtyInput(i)" />
                  <mat-error *ngIf="g.get('qty')?.hasError('min')">Mínimo 0</mat-error>
                  <mat-error *ngIf="g.get('qty')?.hasError('max')">Máximo {{ g.get('maxQty')?.value }}</mat-error>
                </mat-form-field>
              </td>

              <td class="py-2 text-right">
                {{ (g.get('qty')?.value || 0) * (g.get('unitPrice')?.value || 0) | currency:'MXN' }}
              </td>
            </tr>
          </tbody>

          <tfoot>
            <tr class="font-semibold">
              <td colspan="4" class="py-2 text-right">Total Seleccionado:</td>
              <td class="py-2 text-right">{{ totalSelected | currency:'MXN' }}</td>
            </tr>
            <!-- Mensaje si no hay productos seleccionados -->
            <tr *ngIf="submitted && form.hasError('noItems')">
              <td colspan="5" class="text-red-600 py-1 text-right">
                Debes seleccionar al menos un producto.
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Comentarios a todo el ancho con requerido -->
    <mat-form-field appearance="fill" class="mt-2 w-full">
      <mat-label>Comentarios</mat-label>
      <textarea matInput rows="3" formControlName="comments" placeholder="Motivo / notas"></textarea>
      <mat-error *ngIf="submitted && form.get('comments')?.hasError('required')">
        Los comentarios son requeridos.
      </mat-error>
    </mat-form-field>

    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>
  </mat-dialog-content>

  <mat-dialog-actions align="center">
    <button mat-raised-button class="btn-success h-10" (click)="submit()" [disabled]="loading">
      Aplicar
    </button>
    <button mat-button class="btn-cancel ml-2 h-10" (click)="close()" [disabled]="loading">
      Cancelar
    </button>
  </mat-dialog-actions>
</form>