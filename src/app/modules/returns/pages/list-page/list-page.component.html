<shared-loading-page *ngIf="isLoading"></shared-loading-page>

<div class="flex justify-between items-center mb-4 w-full">
  <div class="w-full md:w-2/6">
    <mat-form-field class="h-17 md:w-full w-40 -ml-4">
      <mat-label>Buscar</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Buscar..." #input />
    </mat-form-field>
  </div>
</div>

<h2 class="text-2xl text-center md:w-full mb-4 -mt-6">Devoluciones</h2>

<form [formGroup]="filterForm" (ngSubmit)="filterSales()" class="mb-4">
  <div class="flex flex-col md:flex-row gap-4 w-full">
    <div class="flex flex-row gap-4 w-full md:w-auto">
      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="picker1" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="picker2" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="w-full sm:w-1/2 md:w-48 mb-5 flex items-end">
      <button mat-raised-button class="btn-success w-full md:w-auto" type="submit">Filtrar</button>
    </div>
  </div>
</form>

<!-- Pestañas -->
<mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedTabChange)="onTabChange()">
  <mat-tab label="Devoluciones">
    <ng-template matTabContent>
      <div class="mat-elevation-z8 overflow-x-auto">
        <div class="min-w-[700px]">
          <table mat-table [dataSource]="dataSourceReturns" matSort>
            <!-- No. Ticket -->
            <ng-container matColumnDef="saleId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>No. Ticket</th>
              <td mat-cell *matCellDef="let e">{{ e.saleId }}</td>
            </ng-container>

            <ng-container matColumnDef="businessName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
              <td mat-cell *matCellDef="let e">{{ e.businessName }}</td>
            </ng-container>

            <ng-container matColumnDef="salesPerson">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Vendedor</th>
              <td mat-cell *matCellDef="let e">{{ e.salesPerson }}</td>
            </ng-container>

            <ng-container matColumnDef="saleStatus">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus Ticket</th>
              <td mat-cell *matCellDef="let e">{{ e.saleStatus }}</td>
            </ng-container>

            <ng-container matColumnDef="paymentStatus">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus Cobranza</th>
              <td mat-cell *matCellDef="let e">
                <mat-chip [ngStyle]="getChipStyle(e.paymentStatusId)" style="border:transparent" selected>
                  {{ e.paymentStatus }}
                </mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto Ticket</th>
              <td mat-cell *matCellDef="let e">{{ e.totalAmount | currency }}</td>
            </ng-container>

            <ng-container matColumnDef="saleDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Venta</th>
              <td mat-cell *matCellDef="let e">{{ e.saleDate | date:'short' }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let e">
                <button mat-icon-button class="cursor-pointer" matTooltip="Ver Detalles del Ticket" (click)="openDetailsTicket(e)">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button matTooltip="Ver Movimientos" class="text-blue-600 cursor-pointer" (click)="openMovementsDialog(e)">
                  <mat-icon>article</mat-icon>
                </button>
                <button mat-icon-button class="cursor-pointer" matTooltip="Confirmar Devolución" (click)="openCancellationDialog(e.saleId)">
                  <mat-icon color="warn">find_in_page</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsReturns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsReturns"></tr>
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="999">No hay datos que coincidan con "{{ input.value }}"</td>
            </tr>
          </table>
        </div>
        <mat-paginator [pageSizeOptions]="[25,50,100]" aria-label="Selector de página"></mat-paginator>
      </div>
    </ng-template>
  </mat-tab>

  <mat-tab label="Notas de crédito">
    <ng-template matTabContent>
      <div class="mat-elevation-z8 overflow-x-auto">
        <div class="min-w-[900px]">
          <table mat-table [dataSource]="dataSourceNotes" matSort>

            <ng-container matColumnDef="noteCreditId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>No. Nota</th>
              <td mat-cell *matCellDef="let n">{{ n.noteCreditId }}</td>
            </ng-container>

            <ng-container matColumnDef="saleId">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>No. Ticket</th>
              <td mat-cell *matCellDef="let n">{{ n.saleId }}</td>
            </ng-container>

            <ng-container matColumnDef="clientName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
              <td mat-cell *matCellDef="let n">{{ n.clientName }}</td>
            </ng-container>

            <ng-container matColumnDef="vendedor">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Vendedor</th>
              <td mat-cell *matCellDef="let n">{{ n.vendedor }}</td>
            </ng-container>

            <ng-container matColumnDef="finalCreditAmount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto Crédito</th>
              <td mat-cell *matCellDef="let n">{{ n.finalCreditAmount | currency:'MXN' }}</td>
            </ng-container>

            <ng-container matColumnDef="comments">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Comentarios</th>
              <td mat-cell *matCellDef="let n">{{ n.comments }}</td>
            </ng-container>

            <ng-container matColumnDef="createDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
              <td mat-cell *matCellDef="let n">{{ n.createDate | date:'short' }}</td>
            </ng-container>

            <ng-container matColumnDef="createdBy">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Creado por</th>
              <td mat-cell *matCellDef="let n">{{ n.createdBy }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let n">
                <button mat-icon-button class="cursor-pointer" matTooltip="Ver Nota de Crédito" (click)="openDetailsNoteCredit(n)">
                  <mat-icon>receipt_long</mat-icon>
                </button>
                <button mat-icon-button class="cursor-pointer" matTooltip="Ver Ticket" (click)="openDetailsTicketForNC(n)">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button class="text-green-600 cursor-pointer ml-1" matTooltip="Aprobar Nota de Crédito" (click)="openStatusDialog(n)">
                  <mat-icon>check</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsNotes"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsNotes"></tr>
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="999">No hay datos que coincidan con "{{ input.value }}"</td>
            </tr>
          </table>
        </div>
        <mat-paginator [pageSizeOptions]="[25,50,100]" aria-label="Selector de página"></mat-paginator>
      </div>
    </ng-template>
  </mat-tab>
</mat-tab-group>
