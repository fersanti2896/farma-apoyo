<h2 mat-dialog-title class="text-center text-2xl">Confirmar Pago</h2>

<mat-dialog-content class="flex flex-col gap-4">
    <!-- Stacked chips con info del proveedor -->
    <div *ngIf="!loadingChips" class="space-y-2 mb-2">
        <!-- Chip de proveedor ocupa todo el ancho -->
        <mat-chip class="w-full !justify-between !bg-green-300 !text-blue-800">
            <span class="font-medium">Proveedor: </span>
            <span>{{ (supplierBalance?.businessName || data.businessName) }}</span>
        </mat-chip>

        <!-- Fila para los saldos -->
        <div class="flex gap-2">
            <mat-chip class="flex-1 !justify-between !bg-green-300 !text-blue-800">
                <span class="font-medium">Saldo: </span>
                <span>{{ (supplierBalance?.balance || 0) | currency:'MXN' }}</span>
            </mat-chip>

            <mat-chip class="flex-1 !justify-between !bg-green-300 !text-blue-800">
                <span class="font-medium">Saldo Cta Tercero: </span>
                <span>{{ (supplierBalance?.thirdPartyBalance || 0) | currency:'MXN' }}</span>
            </mat-chip>
        </div>
    </div>

    <mat-progress-bar *ngIf="loadingChips" mode="indeterminate"></mat-progress-bar>

    <!-- Resumen de la nota -->
    <div class="border rounded p-3">
        <div class="font-semibold mb-2">Nota seleccionada</div>
        <table class="w-full text-sm">
            <tbody>
                <tr>
                    <td class="py-1 font-medium"># Factura</td>
                    <td class="py-1 text-right">{{ data.invoiceNumber || '-' }}</td>
                </tr>
                <tr>
                    <td class="py-1 font-medium">Total</td>
                    <td class="py-1 text-right">{{ data.totalAmount | currency:'MXN' }}</td>
                </tr>
                <tr>
                    <td class="py-1 font-medium">Saldo a pagar</td>
                    <td class="py-1 text-right">{{ data.amountPending | currency:'MXN' }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <form [formGroup]="form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
        <!-- Monto -->
        <mat-form-field appearance="fill">
            <mat-label>Monto</mat-label>
            <input matInput type="number" min="0.01" step="0.01" formControlName="amount" />
            <mat-error *ngIf="isValidField('amount')">Monto es requerido y debe ser mayor a 0.</mat-error>
            <mat-error *ngIf="form.get('amount')?.hasError('exceedPending')">
                El monto no puede exceder el saldo a pagar ({{ data.amountPending | currency:'MXN' }}).
            </mat-error>
        </mat-form-field>

        <!-- Método de pago -->
        <mat-form-field appearance="fill">
            <mat-label>Método de pago</mat-label>
            <mat-select formControlName="method">
                <mat-option *ngFor="let m of data.paymentMethods" [value]="m.value">
                    {{ m.label }}
                </mat-option>
            </mat-select>
            <mat-error *ngIf="isValidField('method')">Método de pago es requerido.</mat-error>
        </mat-form-field>

        <!-- Aviso solo para "Pago Cuenta de Tercero" -->
        <div class="md:col-span-2 mt-1" *ngIf="isThirdParty" role="status" aria-live="polite">
            <div
                class="flex items-start gap-2 px-3 py-2 rounded bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                <mat-icon class="mt-0.5" color="primary">info</mat-icon>
                <span>Se restará el saldo a pagar de <strong>Cuenta de Tercero</strong> del proveedor.</span>
            </div>
        </div>

        <!-- Mensaje de error en rojo DEBAJO del aviso azul -->
        <div class="md:col-span-2 -mt-2" *ngIf="isThirdParty && form.get('amount')?.hasError('exceedThirdParty')"
            role="alert" aria-live="assertive">
            <div class="flex items-start gap-2 px-3 py-2 rounded bg-red-50 border border-red-200 text-red-700 text-sm">
                <mat-icon class="mt-0.5" color="warn">info</mat-icon>
                <span>
                    El monto supera el saldo disponible en <strong>Cuenta de Tercero</strong>
                    ({{ supplierBalance?.thirdPartyBalance | currency:'MXN' }}).
                </span>
            </div>
        </div>

        <!-- Comentarios (ocupa 2 columnas) -->
        <mat-form-field appearance="fill" class="md:col-span-2">
            <mat-label>Comentarios</mat-label>
            <textarea matInput rows="3" formControlName="comments"></textarea>
            <mat-error *ngIf="isValidField('comments')">Comentarios es requerido.</mat-error>
        </mat-form-field>
    </form>

    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>
</mat-dialog-content>

<mat-dialog-actions align="center">
    <button mat-raised-button class="btn-success h-10" (click)="aplicar()" [disabled]="loading">
        Aplicar
    </button>
    <button mat-button class="btn-cancel ml-2 h-10" (click)="cancelar()" [disabled]="loading">
        Cancelar
    </button>
</mat-dialog-actions>