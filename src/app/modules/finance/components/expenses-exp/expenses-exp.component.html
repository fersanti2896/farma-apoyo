<shared-loading-page *ngIf="isLoading"></shared-loading-page>

<form [formGroup]="filterForm" (ngSubmit)="filterExpenses()" class="mb-4">
    <div class="flex flex-col md:flex-row gap-4 w-full">
        <div class="flex flex-row gap-4 w-full md:w-auto">
            <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
                <mat-label>Desde</mat-label>
                <input matInput [matDatepicker]="picker1" formControlName="startDate" />
                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                <mat-datepicker #picker1></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
                <mat-label>Hasta</mat-label>
                <input matInput [matDatepicker]="picker2" formControlName="endDate" />
                <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                <mat-datepicker #picker2></mat-datepicker>
            </mat-form-field>
        </div>

        <div class="flex flex-row gap-4 w-full md:w-auto">
            <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-48">
                <mat-label>Categoría</mat-label>
                <mat-select formControlName="expenseCategoryId">
                    <mat-option [value]="null">Todos</mat-option>
                    <mat-option *ngFor="let p of categories" [value]="p.expenseCategoryId">
                        {{ p.name }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Método de Pago -->
            <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-48">
                <mat-label>Método de Pago</mat-label>
                <mat-select formControlName="paymentMethod">
                    <mat-option [value]="null">Todos</mat-option>
                    <mat-option *ngFor="let m of paymentMethods" [value]="m.value">
                        {{ m.label }}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="w-full sm:w-1/2 md:w-48 mb-5 flex items-end">
            <button mat-raised-button class="btn-success h-10 md:w-auto" type="submit">
                Filtrar
            </button>
            <button mat-raised-button class="btn-cancel h-10 ml-2 md:h-10" type="button" (click)="clearFilters()">
                Limpiar
            </button>
        </div>
    </div>
</form>

<div class="flex items-center mb-6 -mt-2 w-full gap-4">
    <button mat-raised-button class="btn-cancel h-10 flex items-center gap-x-1" (click)="exportToPDF()">
        <span>Descargar</span>
        <mat-icon>picture_as_pdf</mat-icon>
    </button>

    <button mat-raised-button class="btn-success h-10 flex items-center gap-x-1" (click)="exportToExcel()">
        <span>Descargar</span>
        <mat-icon>explicit</mat-icon>
    </button>

    <button mat-raised-button class="btn-info h-10 flex items-center gap-x-1" (click)="openCreateExpense()">
        <mat-icon>add</mat-icon>
        <span>Registrar Gasto</span>
    </button>
</div>

<!-- Buscador -->
<div class="flex justify-between items-center mb-4 w-full ml-4">
    <div class="w-full md:w-2/6">
        <mat-form-field class="h-17 md:w-full w-40 -ml-4">
            <mat-label>Buscar</mat-label>
            <input matInput (keyup)="applyFilter($event)" placeholder="Buscar" #input />
        </mat-form-field>
    </div>
</div>

<!-- Tabla -->
<div class="mat-elevation-z8 overflow-x-auto">
    <div class="min-w-[900px]">
        <table mat-table [dataSource]="dataSource" matSort>

            <!-- Id -->
            <ng-container matColumnDef="expensePaymentId">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                <td mat-cell *matCellDef="let r">{{ r.expensePaymentId }}</td>
            </ng-container>

            <!-- Categoría -->
            <ng-container matColumnDef="expenseCategory">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Categoría </th>
                <td mat-cell *matCellDef="let r">{{ r.expenseCategory }}</td>
            </ng-container>

            <!-- Descripción -->
            <ng-container matColumnDef="comments">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Descripción </th>
                <td mat-cell *matCellDef="let r">{{ r.comments }}</td>
            </ng-container>

            <!-- Monto -->
            <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Monto </th>
                <td mat-cell *matCellDef="let r">{{ r.amount | currency:'MXN' }}</td>
            </ng-container>

            <!-- Método de Pago -->
            <ng-container matColumnDef="paymentMethod">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Método de Pago </th>
                <td mat-cell *matCellDef="let r">{{ r.paymentMethod }}</td>
            </ng-container>

            <!-- Fecha de Pago -->
            <ng-container matColumnDef="paymentDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha de Pago </th>
                <td mat-cell *matCellDef="let r">{{ r.paymentDate | date:'short' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="5">No hay datos que coincidan con "{{ input.value }}"</td>
            </tr>
        </table>
    </div>

    <mat-paginator [pageSizeOptions]="[25, 50, 100]" aria-label="Selector de página"></mat-paginator>
</div>