<shared-loading-page *ngIf="isLoading"></shared-loading-page>

<div class="flex justify-between items-center mb-4 w-full">
  <!-- Campo de búsqueda a la izquierda -->
  <div class="w-full md:w-2/6">
    <mat-form-field class="h-17 md:w-full w-40 -ml-4">
      <mat-label>Buscar</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Buscar ticket" #input />
    </mat-form-field>
  </div>
</div>

<h2 class="text-2xl text-center md:w-full mb-4 -mt-6">Reporte de Ventas</h2>

<form [formGroup]="filterForm" (ngSubmit)="filterSales()" class="mb-4">
  <div class="flex flex-col md:flex-row gap-4 w-full">

    <!-- Fila 1: Fechas -->
    <div class="flex flex-row gap-4 w-full md:w-auto">
      <!-- Desde -->
      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="picker1" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>

      <!-- Hasta -->
      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="picker2" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="flex flex-row gap-4 w-full md:w-auto">
      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-48">
        <mat-label>Vendedor</mat-label>
        <mat-select formControlName="salesPersonId">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option *ngFor="let s of users" [value]="s.userId">
            {{ s.firstName }} {{ s.lastName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Botón -->
    <div class="w-full sm:w-1/2 md:w-48 mb-5 flex items-end">
      <button mat-raised-button class="btn-success h-10 md:w-auto" type="submit">
        Filtrar
      </button>

      <button mat-raised-button class="btn-cancel h-10 ml-2 md:h-10" type="button" (click)="clearFilters()">
        Limpiar
      </button>
    </div>
  </div>
</form>

<div class="flex items-center mb-6 -mt-2 w-full gap-4">
  <button mat-raised-button class="btn-cancel h-10 flex items-center gap-x-1" (click)="exportToPDF()">
    <span>Descargar</span>
    <mat-icon>picture_as_pdf</mat-icon>
  </button>

  <button mat-raised-button class="btn-success h-10 flex items-center gap-x-1" (click)="exportToExcel()">
    <span>Descargar</span>
    <mat-icon>explicit</mat-icon>
  </button>
</div>

<div class="mat-elevation-z8 overflow-x-auto mb-6">
  <table mat-table [dataSource]="dataSource" matSort class="w-full">

    <!-- Folio -->
    <ng-container matColumnDef="folio">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Folio</th>
      <td mat-cell *matCellDef="let r">{{ r.folio }}</td>
    </ng-container>

    <!-- Fecha -->
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
      <td mat-cell *matCellDef="let r">{{ r.fecha | date:'short' }}</td>
    </ng-container>

    <!-- Estatus -->
    <ng-container matColumnDef="statusName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Estatus</th>
      <td mat-cell *matCellDef="let r">{{ r.statusName }}</td>
    </ng-container>

    <!-- Cliente -->
    <ng-container matColumnDef="cliente">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
      <td mat-cell *matCellDef="let r">{{ r.cliente }}</td>
    </ng-container>

    <!-- Vendedor -->
    <ng-container matColumnDef="vendedor">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Vendedor</th>
      <td mat-cell *matCellDef="let r">{{ r.vendedor }}</td>
    </ng-container>

    <!-- Totales -->
    <ng-container matColumnDef="totalVenta">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Venta</th>
      <td mat-cell *matCellDef="let r">{{ r.totalVenta | currency:'MXN' }}</td>
    </ng-container>

    <ng-container matColumnDef="totalCompra">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Compra</th>
      <td mat-cell *matCellDef="let r">{{ r.totalCompra | currency:'MXN' }}</td>
    </ng-container>

    <ng-container matColumnDef="utilidad">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Utilidad</th>
      <td mat-cell *matCellDef="let r">{{ r.utilidad | currency:'MXN' }}</td>
    </ng-container>

    <ng-container matColumnDef="totalNotaCredito">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nota Crédito</th>
      <td mat-cell *matCellDef="let r">{{ r.totalNotaCredito | currency:'MXN' }}</td>
    </ng-container>

    <ng-container matColumnDef="totalNotaCreditoCompra">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nota Crédito Compra</th>
      <td mat-cell *matCellDef="let r">{{ r.totalNotaCreditoCompra | currency:'MXN' }}</td>
    </ng-container>

    <ng-container matColumnDef="utilidadFinal">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Utilidad Final</th>
      <td mat-cell *matCellDef="let r">{{ r.utilidadFinal | currency:'MXN' }}</td>
    </ng-container>

    <!-- Rows -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <!-- Paginador -->
  <mat-paginator [pageSizeOptions]="[25, 50, 100]" showFirstLastButtons></mat-paginator>
</div>