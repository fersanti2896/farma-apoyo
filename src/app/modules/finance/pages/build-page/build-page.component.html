<shared-loading-page *ngIf="isLoading"></shared-loading-page>

<h2 class="text-2xl text-center md:w-full mb-6 mt-4">Finanzas - Ingresos</h2>

<form [formGroup]="filterForm" (ngSubmit)="filterSales()" class="mb-6 px-4">
  <div class="flex flex-col md:flex-row gap-4 w-full">
    <div class="flex flex-row gap-4 w-full md:w-auto">
      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="picker1" formControlName="startDate">
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="w-full sm:w-1/2 md:w-36">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="picker2" formControlName="endDate">
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="w-full sm:w-1/2 md:w-48 mb-5 flex items-end">
      <button mat-raised-button class="btn-success w-full md:w-auto" type="submit">
        Filtrar
      </button>
    </div>
  </div>
</form>

<!-- Cards resumen (clickeables) -->
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 px-4 mb-6">
  <div
    *ngFor="let item of summaryData"
    class="bg-white shadow rounded-lg p-4 border border-gray-200 cursor-pointer transition hover:shadow-md"
    (click)="selectMethod(item.paymentMethod)"
  >
    <h3 class="text-lg font-semibold text-gray-700 mb-2">{{ item.paymentMethod }}</h3>
    <p class="text-xl font-bold text-green-700">$ {{ item.totalAmount | number:'1.2-2' }}</p>
  </div>
</div>

<!-- Encabezado de la tabla / filtro activo -->
<div class="px-4 mb-2 flex items-center gap-3" *ngIf="selectedMethod">
  <span class="text-sm">Filtrando por método:</span>
  <mat-chip selected>{{ selectedMethod }}</mat-chip>
  <button mat-stroked-button class="btn-info" (click)="clearMethod()">Ver todos</button>
</div>

<div class="px-4 mb-3 flex gap-3">
  <button mat-raised-button class="btn-cancel" (click)="exportToPDF()">
    Descargar PDF
  </button>
  <button mat-raised-button class="btn-success" (click)="exportToExcel()">
    Descargar Excel
  </button>
</div>


<!-- Tabla de movimientos -->
<div class="mat-elevation-z8 overflow-x-auto px-4 mb-10">
  <div class="min-w-[700px]">
    <table mat-table [dataSource]="resumeDataSource" matSort>

      <ng-container matColumnDef="saleId">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>No. Ticket</th>
        <td mat-cell *matCellDef="let r">{{ r.saleId }}</td>
      </ng-container>

      <ng-container matColumnDef="paymentMethod">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Método</th>
        <td mat-cell *matCellDef="let r">{{ r.paymentMethod }}</td>
      </ng-container>

      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto</th>
        <td mat-cell *matCellDef="let r" class="text-right">{{ r.amount | currency:'MXN' }}</td>
      </ng-container>

      <ng-container matColumnDef="paymentDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Pago</th>
        <td mat-cell *matCellDef="let r" class="text-center">{{ r.paymentDate | date:'short' }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="resumeDisplayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: resumeDisplayedColumns;"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell p-4" colspan="4">No hay movimientos para los filtros actuales.</td>
      </tr>
    </table>
  </div>
  <mat-paginator [pageSizeOptions]="[25, 50, 100]" aria-label="Selector de página"></mat-paginator>
</div>

<!-- Gráfico -->
<div class="w-full px-8">
  <canvas id="financeChart" height="80"></canvas>
</div>
